---
title: "arrow_taxiscratch"
editor: visual
---

```{r}
library(arrow)
library(dplyr)
library(ggplot2)
library(forcats)
library(lubridate)
library(tidyr)
library(readr)



path <- 'data/raw'
filenames <- list.files(path)

merged <- open_dataset(paste0(path, '/', filenames))

merged_credit <- merged %>%
  filter(payment_type == 1, total_amount != 0, !PULocationID %in% c(264, 265)) %>%
  select(PULocationID, DOLocationID, VendorID,
         tip_amount, fare_amount, tolls_amount,
         improvement_surcharge, congestion_surcharge, extra,
         airport_fee, mta_tax, total_amount) %>%
  mutate(
    tip_pct_fare_only = (tip_amount / fare_amount) * 100,
    tip_pct_total = (tip_amount / (fare_amount +
                                     tolls_amount +
                                     improvement_surcharge +
                                     congestion_surcharge +
                                     extra + airport_fee + mta_tax)) * 100
  ) %>%
  filter(is.finite(tip_pct_fare_only), is.finite(tip_pct_total)) # Filter out infinite values


merged_credit_cmt <- merged_credit %>% filter(VendorID == 1)
merged_credit_ver <- merged_credit %>% filter(VendorID == 2)

mean_cmt_fare_only <- merged_credit_cmt %>% summarize(mean_fare = mean(tip_pct_fare_only, na.rm = TRUE)) %>% collect()
mean_cmt_total <- merged_credit_cmt %>% summarize(mean_total = mean(tip_pct_total, na.rm = TRUE)) %>% collect()

mean_ver_fare_only <- merged_credit_ver %>% summarize(mean_fare = mean(tip_pct_fare_only, na.rm = TRUE)) %>% collect()
mean_ver_total <- merged_credit_ver %>% summarize(mean_total = mean(tip_pct_total, na.rm = TRUE)) %>% collect()

print(mean_cmt_fare_only)
print(mean_cmt_total)
print(mean_ver_fare_only)
print(mean_ver_total)


# write the data to a parquet file
#write_parquet(merged_credit, "merged_credit_processed.parquet")
```

```{r}

```
